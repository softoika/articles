---
title: "[Angular] Promiseã‚’ä½¿ã†ã¹ãã‹Observableã‚’ä½¿ã†ã¹ãã‹ã¿ãŸã„ãªè©±"
emoji: "ğŸ¤”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["angular", "rxjs"]
published: false
---
::: message
æœ¬è¨˜äº‹ã¯[Angular Advent Calendar 2020](https://qiita.com/advent-calendar/2020/angular) 4æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
:::

Angularã«ã¯RxJSã¨ã„ã†éåŒæœŸå‡¦ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã§å…¥ã£ã¦ã„ã¾ã™ã€‚
RxJSã¯éåŒæœŸå‡¦ç†ã‚’ã™ã‚‹éš›ã«ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚ˆã†ãªæ©æµã‚’å—ã‘ã‚‰ã‚Œã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚
Angularã®å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è¦‹ã‚Œã°éåŒæœŸå‡¦ç†ã¯ã™ã¹ã¦RxJSã§æ›¸ã‹ã‚Œã¦ã„ã¾ã™ãŒã€
ä¸€æ–¹ã§JavaScript(ES2015ä»¥é™)ã«ã¯Promiseã¨ã„ã†éåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿ãŒã‚ã‚Šã¾ã™ã€‚

RxJSã¨Promiseã©ã¡ã‚‰ã‚’ã©ã†ã„ã†ã¨ãã«ä½¿ãˆã°ã„ã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ
åƒ•ã¯Webãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«Angularã‹ã‚‰å…¥ã£ãŸã®ã§ã€RxJS(Observable)ã®æ€§è³ªã‚‚ã‚ˆãè€ƒãˆãšä½¿ã£ãŸçµæœã€
`switchMap`ãªã©ã®Observableã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚„`combineLatest`ãªã©ã®Observableã‚’çµ„ã¿åˆã‚ã›ã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã®å¤šç”¨ã§åã£ã¦èª­ã¿ã¥ã‚‰ã„ã‚³ãƒ¼ãƒ‰ã«ã—ã¦ã—ã¾ã£ãŸè‹¦ã„çµŒé¨“ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ä¸¡è€…ã®æ€§è³ªã‚’è¸ã¾ãˆãŸä¸Šã§RxJSã«å‘ãã‚±ãƒ¼ã‚¹ã¨Promiseã«å‘ãã‚±ãƒ¼ã‚¹ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# Promiseã®ç°¡å˜ãªãŠã•ã‚‰ã„
Promiseã¯ES2015ã«ç™»å ´ã—ãŸéåŒæœŸå‡¦ç†ã®ä»•çµ„ã¿ã§ã™ã€‚
å¤§ã¾ã‹ã«èª¬æ˜ã™ã‚‹ã¨`Promise.then()`ã§éåŒæœŸçš„ãªå®Ÿè¡Œã‚’ã™ã‚‹ã“ã¨ãŒã§ãã€async/awaitæ§‹æ–‡ã§åŒæœŸçš„ã«ã‚‚æ›¸ã‘ã¾ã™ã€‚
```ts
// 1â†’2ã®é †ã§å®Ÿè¡Œã•ã‚Œã‚‹
new Promise((resolve) => {setTimeout(() => resolve(2), 1000)})
  .then((n) => console.log(n));
console.log(1);
```
```ts
function asyncRandom(n: number): Promise<number> {
  return new Promise((resolve) => setTimeout(() => resolve(n), Math.random() * 1000));
}
// å®Ÿè¡Œé †ã¯æ¯å›ç•°ãªã‚‹
asyncRandom(1).then((n) => console.log(n));
asyncRandom(2).then((n) => console.log(n));
asyncRandom(3).then((n) => console.log(n));

async function run() {
  // ä¸Šã‹ã‚‰ä¸‹ã«é †ç•ªã«å®Ÿè¡Œã•ã‚Œã‚‹
  let n = await asyncRandom(1);
  console.log(n);
  n = await asyncRandom(2);
  console.log(n);
  n = await asyncRandom(3);
  console.log(n);
}
run();
```

# RxJSã®ç°¡å˜ãªãŠã•ã‚‰ã„
RxJSã¯[ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³](https://en.wikipedia.org/wiki/Observer_pattern)ã¨ã„ã†ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è¨­è¨ˆæ‰‹æ³•ã‚’ç”¨ã„ãŸéåŒæœŸå‡¦ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
ã¾ãŸã€[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://rxjs-dev.firebaseapp.com/guide/overview)ã«`Think of RxJS as Lodash for events.`ã¨ä¾‹ãˆã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€
`filter`ã‚„`map`ãªã©ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’ç”¨ã„ã¦å®£è¨€çš„ã«éåŒæœŸçš„ãªå€¤ã‚’æ“ä½œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã‚‚ç‰¹å¾´ã®ä¸€ã¤ã§ã™ã€‚

# RxJSã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆ
RxJSã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆã¯ã¾ã•ã«ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ã‚Šã¾ã™ã€‚
ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚ŠObservableã®è³¼èª­è€…ã¯ä¸€åº¦è³¼èª­(subscribe)ã™ã‚‹ã ã‘ã§ç¶™ç¶šçš„ã«å€¤ã®å¤‰æ›´ã‚’å—ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸã€ï¼‘ã¤ã®Observableã‚’è¤‡æ•°ç®‡æ‰€ã§è³¼èª­ã—ã¦ã„ã‚‹çŠ¶æ³ä¸‹ã§ã¯ãã®Observableã«å€¤ã‚’æµã™ã ã‘ã§ã€è¤‡æ•°ã®è³¼èª­è€…ã«å¯¾ã—åŒæ™‚ã«åŒã˜å€¤ã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## Observable

```ts
const obs = from([1, 2]); // 1â†’2ã¨é †ç•ªã«å€¤ã‚’é€ã‚‹

obs.subscribe(v => console.log('Observer 1:', v));
obs.subscribe(v => console.log('Observer 2:', v));

// Observer 1: 1
// Observer 1: 2
// Observer 2: 1
// Observer 2: 2
```

Observableã®å®Ÿç”¨çš„ãªä¾‹ã¨ã—ã¦ã¯ã€[ActivatedRoute](https://angular.jp/api/router/ActivatedRoute)ã‚’ä½¿ã£ãŸURLã«å«ã¾ã‚Œã‚‹IDã®ç¶™ç¶šçš„ãªå–å¾—ã¨ã„ã†ä¾‹ãŒã‚ã‚Šã¾ã™ã€‚
ä¾‹ãˆã°ã€`/users/:id`ã¨ã„ã†ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šãŒã‚ã£ãŸã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¨IDãŒå¤‰ã‚ã‚‹ã”ã¨ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```ts
@Component({
  selector: 'app-user-profile',
  template: `<app-user-details *ngIf="user" [user]="user"></app-user-details>`
})
class UserProfileComponent implements OnInit {
  user?: User;

  constructor(private route: ActivatedRoute, private userService: UserService) {}

  ngOnInit() {
    this.route.paramMap.pipe(
      // ParamMap â†’ string
      map(params => params.get('id')),
      // Observable<string> â†’ Observable<User>
      switchMap(id => this.userService.fetch(id))
    )
    .subscribe(user => (this.user = user));
  }
}
```
[switchMap](https://rxjs-dev.firebaseapp.com/api/operators/switchMap)ã¯åˆ¥ã®ObservableãªéåŒæœŸå‡¦ç†ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ãã«ä½¿ã„ã¾ã™ã€‚
ã¾ãŸã€switchMapã¯ç›´å‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå®Œäº†ã™ã‚‹å‰ã«æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸå ´åˆã«ã€ç›´å‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸­æ–­ã—ã¦æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã„ã†æ€§è³ªã‚’æŒã£ã¦ã„ã¾ã™ã€‚
ä¸Šè¨˜ã®ä¾‹ã ã¨`id=tanaka`ã‚’å—ã‘å–ã‚Š`GET /users/tanaka`ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚‹å‰ã«ã€`id=suzuki`ãŒé€ã‚‰ã‚Œã¦ããŸå ´åˆã«`GET /users/tanaka`ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã€`GET /users/suzuki`ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚

## Subject
RxJSã®æ©æµã‚’å—ã‘ã‚‹ã«ã¯Subjectã‚‚æ¬ ã‹ã›ãªã„å­˜åœ¨ã§ã—ã‚‡ã†ã€‚
Subjectã¯ç‰¹æ®Šãªãƒ‘ã‚¿ãƒ¼ãƒ³ã®Observableã§ã™ã€‚Observableã¯*read only*ãªObservableã€Subjectã¯*read/write*å¯èƒ½ãªObservableã¨æ‰ãˆã‚‹ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚
ã¾ãŸã€SubjectãŒObservableã¨ç•°ãªã‚‹ç‚¹ã¨ã—ã¦ã€Observableã¯è³¼èª­ã•ã‚Œã‚‹ã¾ã§å®Ÿéš›ã«å€¤ã‚’æµã™ã®ã‚’**ä¿ç•™**ã™ã‚‹ã®ã«å¯¾ã—ã€Subjectã¯ã„ã¤è³¼èª­ã•ã‚Œã‚‹ã‹ã«é–¢ã‚ã‚‰ãšå€¤ã‚’æµã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯ã‚·ãƒ³ãƒ—ãƒ«ãªObservableã®ä¾‹ã§ã™ã€‚subscribeã—ã¦ã„ã‚‹è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã™ã‚‹ã¨å€¤ãŒæµã‚Œãªã„ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
@[stackblitz](https://stackblitz.com/edit/aarh3p?embed=1&file=index.ts&hideExplorer=1&devtoolsheight=100)

ãã—ã¦Subjectã®ä¾‹ã§ã™ã€‚Subjectã«å€¤ãŒ`next()`ã•ã‚ŒãŸæ™‚ç‚¹ã§Subjectã®è³¼èª­è€…ã¯å€¤ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚é€”ä¸­ã‹ã‚‰è³¼èª­ã—ãŸå ´åˆã¯ãã®æ™‚ç‚¹ä»¥é™ã«æµã•ã‚ŒãŸå€¤ã®ã¿å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```ts
const subject = new Subject<number>();

subject.subscribe(x => console.log('Subscriber 1:', x));

subject.next(1);
subject.next(2);

subject.subscribe(x => console.log('Subscriber 2:', x));

subject.next(3);

// Subscriber 1: 1
// Subscriber 1: 2
// Subscriber 1: 3
// Subscriber 2: 3
```

### BehaviorSubject
BehaviorSubjectã¯Subjectã®æ´¾ç”Ÿå‹ã®ä¸­ã§ã‚‚ã‚ˆãä½¿ã†ã®ã§ç´¹ä»‹ã—ã¾ã™ã€‚
BehaviorSubjectã¯Subjectã¨ç•°ãªã‚Šã€subscribeæ™‚ã«ç¾åœ¨ã®å€¤ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```ts
const subject = new BehaviorSubject(0); // BehaviorSubjectã¯åˆæœŸå€¤ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹

subject.subscribe(x => console.log('Subscriber 1:', x));

subject.next(1);
subject.next(2);

subject.subscribe(x => console.log('Subscriber 2:', x));

subject.next(3);

// Subscriber 1: 0
// Subscriber 1: 1
// Subscriber 1: 2
// Subscriber 2: 2
// Subscriber 1: 3
// Subscriber 2: 3
```

ä»¥ä¸‹ã¯2å›ç›®ä»¥é™ã®å‘¼ã³å‡ºã—ã§ã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã†ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ä¾‹ã§ã™ã€‚(åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®å–å¾—ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã¯è€ƒæ…®ã—ã¾ã›ã‚“)
```ts
export class UserService {
  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ngOnInitã§ã“ã®user$ã‚’subscribeã™ã‚‹ã‹asyncãƒ‘ã‚¤ãƒ—ã«æ¸¡ã™ã ã‘ã§ã„ã„
  get user$() {
    return this.userSubject.asObservable();
  }
  private userSubject = new BehaviorSubject<User |  null>(null);

  constructor(private httpClient: HttpClient) { }
  
  async fetch(userId: User['id']) {
    const cached = await this.user$.pipe(take(1)).toPromise();
    if (!cached) {
      const user = await this.httpClient.get<User>(`/users/${userId}`).toPromise();
      userSubject.next(user);
    }
  }

  async update(user: User) {
    const user = await this.httpClient.put<User>(`/users/${user.id}`, user);
    userSubject.next(user);
  }
}
```
ã“ã®ä¾‹ã§ã¯å˜æ–¹å‘ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚‚å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

:::details å‚™è€ƒ
ã“ã®å®Ÿè£…ã«ã¯ã„ãã¤ã‹æ³¨æ„ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

asyncãƒ‘ã‚¤ãƒ—ã«`user$`ã®ã‚ˆã†ãªå…ƒSubjectã®Observableã‚’æ¸¡ã—ãŸã„å ´åˆã€BehaviorSubjectã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚[[ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«]](https://stackblitz.com/edit/angular-ivy-3sxjvz?file=src/app/app.component.ts)

ã¾ãŸã€å®Ÿè£…ä¾‹ã«ã‚ã‚‹é€šã‚Šã€Subject/BehaviorSubjectã‚’Promiseã«å¤‰æ›ã™ã‚‹ã«ã¯`take(1)`ã‚’æŒŸã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
`toPromise()`ã¯Observableã®`complete`ã‚’å¾…ã¤å®Ÿè£…ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚[[ã‚„ã‚„å¤ã„ã§ã™ãŒæƒ…å ±æºã¯ã“ã¡ã‚‰]](https://github.com/ReactiveX/rxjs/issues/2536) [[ã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«]](https://stackblitz.com/edit/rxjs-mqdvar?file=index.ts)

ã“ã®ä¾‹ã§ã¯`toPromise()`ã‚’ç”¨ã„ã¦Promiseã«å¤‰æ›ã—ã¦ã„ã¾ã™ãŒã€å®Ÿã¯æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®RxJS v7ã§ã¯deprecatedã«ãªã‚Šã¾ã™(v8ã§æ¶ˆã•ã‚Œã¾ã™)ã€‚
RxJS v7/v8ä»¥é™ã§ã¯`lastValueFrom()`/`firstValueFrom()`ã¨ã„ã†é–¢æ•°ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã‚Œã‚‰ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚[[å‚è€ƒ]](https://indepth.dev/rxjs-heads-up-topromise-is-being-deprecated/)
å¤‰æ›ãŒå¤§å¤‰ãªã®ã§Angularã§ã¯`ng update`ã§ã‚ˆã—ãªã«ã—ã¦ãã‚Œã‚‹ã¨ã„ã„ã§ã™ã­ã€‚
:::


ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯`user$`ã‚’åˆæœŸåŒ–æ™‚ã«è³¼èª­ã—ã¦ãŠã‘ã°ã€ã„ã¤userã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚Œã°ã„ã„ã®ã‹ã‚’æ°—ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
ä»¥ä¸‹ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…ä¾‹ã§ã™
```ts
@Component({
  selector: 'app-user-profile',
  template: `
    <app-user-details
      *ngIf="user$ | async as user"
      [user]="user"
      (update)="onUpdate($event)"
    ></app-user-details>
  `
})
class UserProfileComponent implements OnInit {
  get user$() {
    return this.userService.user$
  }

  constructor(private userService: UserService) {}

  ngOnInit() {
    this.route.paramMap.pipe(
      map(params => params.get('id'))
    )
    .subscribe(id => this.userService.fetch(id));
  }

  onUpdate(user: User) {
    this.userService.update(user);
  }
}
```
ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒè¦‹ã¦å–ã‚Œã¾ã™ã€‚

# RxJSã‚’ä½¿ã†ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
operatorã®ç¨®é¡ãŒå¤šãã€è‡ªç”±åº¦ãŒé«˜ã„â†’åŒã˜ã‚ˆã†ãªã“ã¨ã‚’å®Ÿç¾ã™ã‚‹ã«ã—ã¦ã‚‚æ›¸ãæ–¹ã«å·®ãŒå‡ºã‚‹
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ï¼‘åº¦ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦è¤‡æ•°ã®éåŒæœŸå‡¦ç†ãŒçµ¡ã‚€å ´åˆã€è¤‡é›‘ãªæ›¸ãæ–¹ãŒè¦æ±‚ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹
switchMapã‚„combineLatestãªã©
ãã®å ´åˆã«ã¯Promiseã¨async/awaitã‚’ä½¿ã£ãŸæ–¹ãŒã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ã‘ã‚‹(çµŒé¨“ä¸Š)
